# Registro de sucesos o _logging_

El _logging_ es la acci贸n de registrar un suceso. La forma m谩s sencilla de
hacer esto es con `print`, como venimos haciendo desde el comienzo del curso.

Sin embargo, conforme crees software m谩s y m谩s complejo te dar谩s cuenta de
que `print` es una soluci贸n muy limitada. 驴Qu茅 pasa cuando quieres eliminar
los `print` que pusiste para depurar una funci贸n? 驴Los borrar铆as f铆sicamente
del c贸digo fuente? 驴Los comentar铆as?

驴Y si decides informar en un fichero? 驴O informar siguiendo diferentes
estrategias en funci贸n de la severidad del suceso?

Este problema es tan com煤n en desarrollo de software que Python incluye
el complet铆simo sistema de registro aqu铆 presentado.

Para esta lecci贸n, en lugar de una sesi贸n interactiva, utiliza PyCharm como
hicistes en la lecci贸n anterior. Los ejemplos son m谩s largos pero tambi茅n
autocontenidos, de forma que puedas **reemplazar completamente** el contenido
del fichero de prueba con el del ejemplo.

## El registrador de sucesos

1. La funcionalidad de registro se encuentra centralizada en el m贸dulo
`logging`:

    ```python
    import logging
    logging.warning('Warning, enemy approaching! ')
    logging.info('I am Ziltoid, the Omniscient.')
    ```

    Ejecuta el m贸dulo con estos comandos y deber铆as ver la siguiente l铆nea
    en la consola:

    ```
    WARNING:root:Warning, enemy approaching! 
    ```

2. El segundo mensaje, proveniente de la funci贸n `logging.info` no se imprime
porque el nivel de registro por defecto es `WARNING` o advertencia. Podemos
cambiar el nivel de _logging_ con:

    ```python
    import logging
    logging.basicConfig(level=logging.DEBUG)
    logging.info('I am Ziltoid, the Omniscient.')
    logging.warning('Warning, enemy approaching! ')
    logging.debug('There should be no more messages after this')
    ```

    Ahora podemos ver todos los mensajes, puesto que `DEBUG` es el nivel
    m谩s "bajo" e incluye los mensajes procedentes de `logging.debug` y
    nieveles "superiores":

    | Value | Nivel    | Descrici贸n   |
    |-------|----------|--------------|
    | 50    | CRITICAL | Un problema que implica el fin de la ejecuci贸n.
    | 40    | ERROR    | Un problema que requiere la intervenci贸n del usuario.
    | 30    | WARNING  | Advierte de un posible problema futuro.
    | 20    | INFO     | Confirman que las cosas funcionan como se espera.
    | 10    | DEBUG    | Informaci贸n detallada, por motivos de diagn贸stico.

3. Por defecto, **Python no configura el nivel de registro respecto de nada**.
Si queremos hacer depender el nivel de registro de una variable de entorno
o de un argumento pasado a nuestro programa **tenemos que programarlo
expl铆citamente**:

    ```python
    from collections import defaultdict
    import logging
    import argparse
    import os

    _LOG_LEVELS = defaultdict(lambda: logging.WARNING, {
        'DEBUG': logging.DEBUG,
        'INFO': logging.INFO,
        'WARNING': logging.WARNING
    })

    # Get level from params
    parser = argparse.ArgumentParser()
    parser.add_argument('-v', '--verbosity', action='count', default=0)
    args = parser.parse_args()

    # Get level from environment
    environment_level = os.environ.get('DEBUG', '').upper()

    # Decide priority of the level source
    log_level = logging.WARNING

    if args.verbosity:
        log_level = max(logging.WARNING - 10 * args.verbosity, 10)

    elif environment_level:
        log_level = _LOG_LEVELS[environment_level]

    # Config log level
    logging.basicConfig(level=log_level)

    # Test
    logging.debug(f'log level set to {log_level}')
    logging.warning('Enemy approaching')
    logging.info('Deploying defences')
    ```

4. S贸lo la primera llamada a `logging.basicConfig` tienen efecto, todas las
dem谩s no tienen efecto.

    ```python
    import logging

    logging.basicConfig(level=logging.INFO)
    logging.basicConfig(level=logging.DEBUG)

    logging.warning('Enemy approaching')
    logging.info('Deploying defences')
    logging.debug('this will never show up')
    ```

5. Puedes registrar sucesos desde m煤ltiples registradores con la factor铆a
`logging.getLogger(logger_name)`.

    ```python
    import logging
    control = logging.getLogger('control')
    defense = logging.getLogger('defense')
    control.warning('Enemy approaching')
    defense.warning('Running out of ammo...')
    ```

    F铆jate en que los mensajes han perdido el formato. Los nuevos _loggers_
    no tienen ning煤n formato asociado y, para configurarlo, tienes que
    llamar a `logging.basicConfig`.

    ```python
    import logging
    logging.basicConfig()
    control = logging.getLogger('control')
    defense = logging.getLogger('defense')
    control.warning('Enemy approaching')
    defense.warning('Running out of ammo...')
    ```

    No hace falta que `logging.basicConfig()` aparezca antes de la creaci贸n
    de los registradores pero s铆 antes de cualquier llamada a uno de los
    m茅todos de registro.

6. Un patr贸n muy extendido es el de asignar al nombre del _logger_, el nombre
del m贸dulo. As铆:

    ```python
    import logging
    logging.basicConfig()
    logger = logging.getLogger(__name__)
    logger.warning('May I have your attention, please?')
    ```

    Ahora crea un m贸dulo distinto y copia dentro el mismo c贸digo que antes.
    Modifica el primero para que importe al segunto.

7. Si el formato del mensaje no te gusta, puedes cambiarlo con:

    ```python
    import logging
    logging.basicConfig(
        format='%(asctime)s [%(levelname)s] %(name)s: %(message)s')
    logger = logging.getLogger(__name__)
    logger.warning('May I have your attention, please?')
    ```

    Hay [otros valores](https://docs.python.org/3/library/logging.html#logrecord-attributes)
    que puedes usar el la cadena de formato.

8. Como has comprobado, el destino de los logs es la consola, aunque podr铆a
ser un fichero:

    ```python
    import logging
    logging.basicConfig(filename='application.log')
    logger = logging.getLogger(__name__)
    logger.warning('May I have your attention, please?')
    ```

    Esta modalidad a帽ade logs al final de los que ya hab铆a, sin vac铆ar nunca
    el fichero.

* [Documentaci贸n de `basicConfig`](https://docs.python.org/3/library/logging.html#logging.basicConfig)


### Registrando excepciones

Puedes imprimir una excepci贸n, con su traza inclu铆da, si desde un manejador
de excepci贸nes, llamas a `Logger.exception()`:

    ```python
    import logging

    logger = logging.getLogger(__name__)

    try:
        print(1/0)
    except ZeroDivisionError:
        logger.exception('Someone tried to divide between 0')
    ```

## La jerarqu铆a de _loggers_

Los distintos _loggers_ siguen una jerarqu铆a especificada por sus nombres
separados por puntos. Por ello, utilizar el nombre del m贸dulo es una
buena idea, puesto que los puntos que reflejan la jerarqu铆a paquete-m贸dulo
sirve para definir la jerarqu铆a de _loggers_.

El _logger_ ra铆z, o `'root'` es aquel al que se puede acceder a trav茅s de
`logging.info`, o `logging.warning` o cualquiera de las otras funciones en
el m贸dulo.

## Configuraci贸n avanzada

La funci贸n `logging.basicConfig` cubre la mayor铆a de casos sencillos pero
Python es capaz de hacer m谩s. Los _loggers_ se pueden configurar
individualmente, por ejemplo, para enviar ciertos registros por _e-mail_,
mientras que otros se muestran por consola o para establecer niveles distintos
por m贸dulo.

Los m贸dulos admiten manejadores (_handlers_) y estos, formateadores
(_formatters_). El manejador env铆a un registro a un destino (por ejmplo,
la consola, un fichero, un tweet, una issue en GitHub...) y el formateador
decide el formato de salida (texto plano, formato binario, JSON, Markdown...).

1. Los distintos _loggers_ pueden configurarse de maneras distintas.

    ```python
    import logging

    default_formatter = logging.Formatter(
        '%(asctime)s:[%(levelname)s]:%(name)s:%(message)s')

    control = logging.getLogger('control')
    control.setLevel(logging.INFO)
    to_control_log_file_handler = logging.FileHandler('control.log')
    to_control_log_file_handler.setFormatter(default_formatter)
    control.addHandler(to_control_log_file_handler)

    defense = logging.getLogger('defense')
    defense.setLevel(logging.WARNING)
    to_defense_log_file_handler = logging.FileHandler('defense.log')
    to_defense_log_file_handler.setFormatter(default_formatter)
    defense.addHandler(to_defense_log_file_handler)

    control.info('No news, good news')
    control.warning('Enemy, incoming')

    defense.info('Cleaning out the enemy')
    defense.warning('Running out of ammo')
    ```

    Observa los registros en `control.log` y `defense.log`.

2. Si los _loggers_ siguen una jerarqu铆a, los manejadores de los padres
tambi茅n manejan todos los registros env铆ados a los hijos.

    ```python
    import logging

    default_formatter = logging.Formatter(
        '%(asctime)s:[%(levelname)s]:%(name)s:%(message)s')

    control = logging.getLogger('control')
    control.setLevel(logging.INFO)
    to_control_log_file_handler = logging.FileHandler('control.log')
    to_control_log_file_handler.setFormatter(default_formatter)
    control.addHandler(to_control_log_file_handler)

    # now defense is a child of control
    defense = logging.getLogger('control.defense')
    defense.setLevel(logging.WARNING)
    to_defense_log_file_handler = logging.FileHandler('defense.log')
    to_defense_log_file_handler.setFormatter(default_formatter)
    defense.addHandler(to_defense_log_file_handler)

    control.info('No news, good news')
    control.warning('Enemy, incoming')

    defense.info('Cleaning out the enemy')
    defense.warning('Running out of ammo')
    ```

    Observa atentamente `control.log` para ver qu茅 ha pasado.

3. Lo cual es 煤til porque, en escenarios no muy complicados, permite
una configuraci贸n m谩s granular que `basicConfig`, sin excesiva complejidad,
configurando 煤nicamente el _logger_ ra铆z.

    ```python
    import logging

    default_formatter = logging.Formatter(
        '%(asctime)s:[%(levelname)s]:%(name)s:%(message)s')

    root_logger = logging.getLogger('root')
    root_logger.setLevel(logging.DEBUG)
    log_file_handler = logging.FileHandler('everything.log')
    log_file_handler.setFormatter(default_formatter)
    root_logger.addHandler(log_file_handler)

    control = logging.getLogger('root.control')
    control.setLevel(logging.INFO)

    defense = logging.getLogger('root.defense')
    defense.setLevel(logging.WARNING)

    control.info('No news, good news')
    control.warning('Enemy, incoming')

    defense.info('Cleaning out the enemy')
    defense.warning('Running out of ammo')
    ```

4. Recordando el patr贸n de nombrar tu _logger_ como tus paquetes, 驴podr铆as
    trasladar el ejemplo anterior a una estructura de m贸dulos como esta? Crea
    el paquete `airdefense` dentro de tu paquete de alumno.

    ```bash
    airdefense
     __init__.py
     control.py
     defense.py
    ```

    Lo que ahora es la configuraci贸n de `root`, ponlo en `__init__.py` pero
    recuerda obtener el nombre del _logger_ a partir del nombre del m贸dulo:

    ```python
    import logging
    logger = logging.getLogger(__name__)
    ```

    El _logger_ llamado `control` y su configuraci贸n mu茅velo dentro de
    `control.py`. El _logger_ llamado `defense` y su configuraci贸n ll茅valo
    al fichero `defense.py`. Recuerda nombrar esos _loggers_ como sus m贸dulos.

    Cuando termines abre una sesi贸n interactiva en la carpeta padre de
    `airdefense` e importa los m贸dulos. 驴Qu茅 ha pasado?

5. M煤ltiples handlers son posibles por logger. Por ejemplo: registrar todos
los sucesos por consola y 煤nicamente dejar en un fichero los de nivel `ERROR`:

    ```python
    import sys
    import logging

    default_formatter = logging.Formatter(
        '%(asctime)s:[%(levelname)s]:%(name)s:%(message)s')

    root_logger = logging.getLogger('root')
    root_logger.setLevel(logging.DEBUG)

    log_file_handler = logging.FileHandler('error.log')
    log_file_handler.setLevel(logging.ERROR)
    log_file_handler.setFormatter(default_formatter)

    stdout_handler = logging.StreamHandler(sys.stdout)
    stdout_handler.setFormatter(default_formatter)

    root_logger.addHandler(log_file_handler)
    root_logger.addHandler(stdout_handler)

    root_logger.info('No news, good news.')
    root_logger.info('Everything is fine.')
    root_logger.warning('Enemy, incoming!')
    root_logger.error('Communication tower destroyed!')
    root_logger.critical('HQ destroyed!')
    ```

    F铆jate en las dos apariciones del m茅todo `setLevel`. La primera opera
    sobre el _logger_, e indica qu茅 niveles de mensaje alcanzan los distintos
    manejadores. La segunda aparici贸n opera sobre el manejador e indica qu茅
    mensajes alcanzan el destino. Es decir, que act煤a como un filtro.

* Libro de recetas para
[pr谩cticas populares de _logging_ en Python](https://docs.python.org/3/howto/logging-cookbook.html)*
* Gu铆a de Python sobre el [uso avanzado del m贸dulo `logging`.](https://docs.python.org/3/howto/logging.html#advanced-logging-tutorial)
* Configuraci贸n [declarativa con diccionarios y ficheros](https://docs.python.org/3/library/logging.config.html#logging-config-api)

## Advertencias

Adem谩s del registro de sucesos, Python proporciona el m贸dulo `warnings` para
informar de ciertos aspectos al usuario. Su diferencia con el m茅todo `warning`
radica en que la informaci贸n va dirijida al usuario, no al desarrollador
de la aplicaci贸n.

Esto quiere decir, en esencia, que el usuario puede hacer algo para eliminar
la advertencia, sin tener que alterar el c贸digo de la biblioteca que produce
la advertencia.

Quiz谩, el m谩s famoso de los _warnings_ sea el `DeprecationWarning`, que
indica que una caracter铆stica es obsoleta y se retirar谩 en un futuro cercano:

```python
import warnings

def new_api(*args, **kwargs):
    ...

def old_api(*args, **kwargs):
    warnings.warn('Use `new_api()`', DeprecationWarning)
    return new_api(*args, **kwargs)

old_api()
```

PyCharm, por ejemplo, detecta el uso de `DeprecationWarning` y lo indica en
el editor.

Las advertencias pueden ser reinterpretadas por el sistema de registro de
sucesos como sucesos de nivel `WARNING` si se activa la opci贸n:

```python
import logging
import warnings
logging.basicConfig()
logging.captureWarnings(True)
warnings.warn('Be prepared!')
```

* [Documentaci贸n del m贸dulo `warnings`](https://docs.python.org/3/library/warnings.html)

## 驴Cu谩ndo usar qu茅?

A lo largo del curso te has encontrado con muchas formas de notificar
informaci贸n: `print`, excepciones, y ahora registros y advertencias. Esta tabla
es una recomendaci贸n para cu谩ndo usar qu茅 caracter铆stica:

| Qu茅 quieres hacer | Qu茅 usar |
|-------------------|----------|
| Comunicar informaci贸n **al usuario** | `print()`
| Informar **al desarrollador** de que todo va bien | `logging.info()`
| Asistir **al desarrollador** con el diagn贸stico   | `logging.debug()`
| Advertir **al usuario** de algo | `warnings.warn()`
| Advertir **al desarrollador** de algo | `logging.warning()`
| Informar de un error en tiempo de ejecuci贸n | lanzar una excepci贸n
| Informar de un error sin interrumpir la ejecuci贸n de un programa | `logging.error()`

## Buenas pr谩cticas en el registro de sucesos

Cuando hablamos de informaci贸n para el desarrollador, nos referimos a **quienes
han creado el software** que otros usan, bien en forma de programa, bien en
forma de biblioteca. Este otro es **el usuario**.

Cuando hablamos del desarrollador no nos referimos a un individuo en particular
sino a un potencial equipo de desarrollo, incluyendo personas y herramientas
de desarrollo.

Es conveniente cuidar el formato, la organizaci贸n y el grado de detalle de los
registros de eventos porque son la principal ayuda que tendr谩s a la hora de
diagnosticar problemas y solventarlos.

Recuerda siempre que tu eres el principal consumidor de estos registros. T煤
y tus herramientas de desarrollo. Por ejemplo, aunque no es com煤n, no descartes
registrar los eventos en formatos como YAML o JSON, que son f谩ciles de leer
tanto para m谩quinas como para personas.

Dicho ingenuamente, "ponte las cosas f谩ciles".

* [The Art of Logging](https://www.codeproject.com/Articles/42354/The-Art-of-Logging)*
* Gu铆a de [integraci贸n con software cliente](https://docs.python.org/3/howto/logging.html#configuring-logging-for-a-library)
